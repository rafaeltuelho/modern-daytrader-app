# ===========================================
# Application Configuration
# ===========================================
quarkus.application.name=daytrader-account-service
quarkus.http.port=8081

# ===========================================
# PostgreSQL Connection
# ===========================================
quarkus.datasource.db-kind=postgresql

# Production database configuration
%prod.quarkus.datasource.username=${DB_USERNAME:daytrader}
%prod.quarkus.datasource.password=${DB_PASSWORD:daytrader}
%prod.quarkus.datasource.jdbc.url=jdbc:postgresql://${DB_HOST:localhost}:${DB_PORT:5432}/${DB_NAME:daytrader}

# Dev mode - uses Dev Services (Testcontainers) for PostgreSQL
%dev.quarkus.datasource.devservices.enabled=true
%dev.quarkus.datasource.devservices.image-name=postgres:16-alpine
%dev.quarkus.datasource.devservices.db-name=daytrader_account

# Connection Pool (Agroal)
quarkus.datasource.jdbc.min-size=5
quarkus.datasource.jdbc.max-size=20
quarkus.datasource.jdbc.initial-size=5
quarkus.datasource.jdbc.acquisition-timeout=30s
quarkus.datasource.jdbc.idle-removal-interval=2m
quarkus.datasource.jdbc.max-lifetime=10m
quarkus.datasource.jdbc.validation-query-sql=SELECT 1
quarkus.datasource.jdbc.background-validation-interval=2m

# ===========================================
# Hibernate ORM
# ===========================================
quarkus.hibernate-orm.database.generation=none
quarkus.hibernate-orm.log.sql=false
quarkus.hibernate-orm.jdbc.statement-batch-size=25
quarkus.hibernate-orm.jdbc.statement-fetch-size=50
quarkus.hibernate-orm.physical-naming-strategy=org.hibernate.boot.model.naming.CamelCaseToUnderscoresNamingStrategy

# ===========================================
# Flyway
# ===========================================
quarkus.flyway.migrate-at-start=true
quarkus.flyway.locations=classpath:db/migration
quarkus.flyway.validate-on-migrate=true
quarkus.flyway.clean-disabled=true
quarkus.flyway.baseline-on-migrate=false

# ===========================================
# JWT Configuration (Simple JWT - No OIDC/Keycloak)
# ===========================================
# JWT issuer - should match the issuer claim in generated tokens
mp.jwt.verify.issuer=https://daytrader.example.com
smallrye.jwt.sign.key.location=privateKey.pem
smallrye.jwt.verify.key.location=publicKey.pem

# Token configuration
mp.jwt.verify.audiences=daytrader-api
smallrye.jwt.new-token.lifespan=3600
smallrye.jwt.new-token.issuer=https://daytrader.example.com

# ===========================================
# Authorization Policies
# ===========================================
# Public endpoints (no authentication required)
quarkus.http.auth.permission.public.paths=/q/health/*,/q/metrics/*,/q/openapi/*,/swagger-ui/*,/openapi/*
quarkus.http.auth.permission.public.policy=permit

# Auth endpoints are public (login, register)
quarkus.http.auth.permission.auth.paths=/api/auth/*,/api/accounts
quarkus.http.auth.permission.auth.policy=permit
quarkus.http.auth.permission.auth.methods=POST

# Internal service-to-service endpoints (balance update for order processing)
# This must come before the authenticated catch-all policy
quarkus.http.auth.permission.internal.paths=/api/accounts/*/balance
quarkus.http.auth.permission.internal.policy=permit
quarkus.http.auth.permission.internal.methods=PUT

# Authenticated endpoints (any valid token)
quarkus.http.auth.permission.authenticated.paths=/api/*
quarkus.http.auth.permission.authenticated.policy=authenticated

# Role-based policies
quarkus.http.auth.policy.trader-policy.roles-allowed=trader,admin
quarkus.http.auth.policy.admin-policy.roles-allowed=admin

# ===========================================
# CORS Configuration
# ===========================================
quarkus.http.cors=true
quarkus.http.cors.origins=${CORS_ORIGINS:http://localhost:3000,http://localhost:3001}
quarkus.http.cors.headers=accept,authorization,content-type,x-requested-with
quarkus.http.cors.methods=GET,POST,PUT,DELETE,OPTIONS
quarkus.http.cors.exposed-headers=location,info
quarkus.http.cors.access-control-max-age=24H
quarkus.http.cors.access-control-allow-credentials=true

# ===========================================
# Security Headers
# ===========================================
quarkus.http.header."X-Content-Type-Options".value=nosniff
quarkus.http.header."X-Frame-Options".value=DENY
quarkus.http.header."X-XSS-Protection".value=1; mode=block
quarkus.http.header."Strict-Transport-Security".value=max-age=31536000; includeSubDomains
quarkus.http.header."Content-Security-Policy".value=default-src 'self'

# ===========================================
# Metrics Configuration
# ===========================================
quarkus.micrometer.enabled=true
quarkus.micrometer.registry-enabled-default=true
quarkus.micrometer.binder-enabled-default=true
quarkus.micrometer.export.prometheus.enabled=true
quarkus.micrometer.export.prometheus.path=/q/metrics

# Custom metrics prefix
quarkus.micrometer.binder.jvm=true
quarkus.micrometer.binder.http-client.enabled=true
quarkus.micrometer.binder.http-server.enabled=true
quarkus.micrometer.binder.system=true

# ===========================================
# OpenTelemetry / Tracing Configuration
# ===========================================
quarkus.otel.enabled=true
quarkus.otel.sdk.disabled=false

# Service name (appears in traces)
quarkus.otel.service.name=${quarkus.application.name}

# OTLP exporter configuration (Jaeger)
quarkus.otel.exporter.otlp.endpoint=${OTEL_EXPORTER_ENDPOINT:http://localhost:4317}
quarkus.otel.exporter.otlp.traces.protocol=grpc
quarkus.otel.exporter.otlp.traces.compression=gzip

# Sampling (adjust for production - 1.0 = 100% of traces)
quarkus.otel.traces.sampler=parentbased_traceidratio
quarkus.otel.traces.sampler.arg=1.0

# Propagation format
quarkus.otel.propagators=tracecontext,baggage

# Resource attributes
quarkus.otel.resource.attributes=service.namespace=daytrader,deployment.environment=${ENVIRONMENT:development}

# ===========================================
# Logging Configuration
# ===========================================
quarkus.log.console.enable=true
quarkus.log.console.format=%d{yyyy-MM-dd HH:mm:ss.SSS} %-5p [%c{2.}] (%t) %s%e%n
quarkus.log.console.level=INFO
quarkus.log.console.color=true

# JSON logging for production (structured logs)
%prod.quarkus.log.console.json=true
%prod.quarkus.log.console.json.date-format=yyyy-MM-dd HH:mm:ss.SSS
%prod.quarkus.log.console.json.exception-output-type=formatted
%prod.quarkus.log.console.json.print-details=true

# Log categories
quarkus.log.category."com.daytrader".level=DEBUG
quarkus.log.category."org.hibernate.SQL".level=DEBUG

